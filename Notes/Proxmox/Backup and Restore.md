---
created: 2025-01-27
tags: [proxmox, virtualization, backup, restore]
category: infrastructure
---

# Proxmox VE - Резервное копирование

## Обзор

Операции резервного копирования и восстановления виртуальных машин в Proxmox VE.

## Создание резервной копии VM

### Создание резервной копии виртуальной машины

Создать резервную копию виртуальной машины:

```bash
vzdump 103 \
  --storage local \
  --node pve \
  --notification-mode auto \
  --compress zstd \
  --remove 0 \
  --mode snapshot \
  --notes-template '{{guestname}}'
```

**Параметры:**
- `103` - ID виртуальной машины
- `--storage local` - Целевое хранилище
- `--node pve` - Имя узла Proxmox
- `--notification-mode auto` - Отправлять уведомления
- `--compress zstd` - Алгоритм сжатия (zstd, gzip, lzo)
- `--remove 0` - Хранить 0 старых резервных копий (0 = хранить все)
- `--mode snapshot` - Режим снимка (snapshot, stop, suspend)
- `--notes-template` - Шаблон для заметок резервной копии

### Режимы резервного копирования

- `snapshot` - Живое резервное копирование (рекомендуется)
- `stop` - Остановить VM, создать резервную копию, запустить VM
- `suspend` - Приостановить VM во время резервного копирования

## Восстановление VM из резервной копии

### Восстановление виртуальной машины

Восстановить VM из файла резервной копии:

```bash
qmrestore ./vzdump-qemu-103-2024_04_15-14_27_13.vma.zst \
  350 \
  --storage local
```

**Параметры:**
- `vzdump-qemu-103-*.vma.zst` - Файл резервной копии
- `350` - Новый ID виртуальной машины (должен быть уникальным)
- `--storage local` - Целевое хранилище

### Опции восстановления

- Изменить ID VM во время восстановления
- Восстановить на другое хранилище
- Восстановить на другой узел

## Рекомендации по резервному копированию

1. **Регулярные резервные копии** - Запланируйте автоматические резервные копии
2. **Сжатие** - Используйте zstd для лучшего соотношения сжатие/скорость
3. **Хранение** - Настройте `--remove` для управления дисковым пространством
4. **Проверка** - Регулярно тестируйте процедуры восстановления
5. **Внешнее хранилище** - Копируйте резервные копии на внешнее хранилище

## Автоматизированный скрипт резервного копирования

```bash
#!/bin/bash
# Резервное копирование всех VM на узле

VM_LIST=$(qm list | awk 'NR>1 {print $1}')

for VMID in $VM_LIST; do
    echo "Создание резервной копии VM $VMID..."
    vzdump $VMID \
        --storage local \
        --compress zstd \
        --mode snapshot \
        --remove 7  # Хранить последние 7 резервных копий
done
```

## Полезные команды

### Список всех виртуальных машин

```bash
qm list
```

### Просмотр информации о VM

```bash
qm status 103
qm config 103
```

### Управление хранилищами

```bash
pvesm status
pvesm list local
```

## Связанные заметки

- [[../Linux/System Administration]]

