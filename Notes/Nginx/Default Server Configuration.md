---
created: 2025-01-27
tags: [nginx, web-server, security, configuration, server-name]
category: infrastructure
---

# Конфигурация Default Server для Nginx

## Обзор

Конфигурация default server позволяет отклонять все запросы, которые не соответствуют директивам `server_name` в других блоках сервера. Это повышает безопасность, предотвращая доступ к серверу по IP-адресу или неожиданным доменным именам.

## Проблема

По умолчанию Nginx использует первый блок `server` как default server, если запрос не соответствует ни одному `server_name`. Это может привести к:
- Доступу к серверу по IP-адресу
- Доступу через неожиданные доменные имена
- Утечке информации о конфигурации сервера

## Решение

Создать отдельный default server блок, который будет отклонять все несоответствующие запросы.

## Конфигурация

### HTTP (порт 80)

```nginx
server {
    listen 80 default_server;

    server_name _;
    server_name_in_redirect off;

    return 444;
}
```

**Директивы:**
- `listen 80 default_server` - Прослушивать порт 80 как default server
- `server_name _` - Специальное значение, означающее "любое несоответствующее имя"
- `server_name_in_redirect off` - Отключить использование server_name в редиректах
- `return 444` - Закрыть соединение без ответа (специальный код Nginx)

### HTTPS (порт 443)

```nginx
server {
    listen 443 ssl default_server;

    server_name _;
    server_name_in_redirect off;

    ssl_certificate     /etc/nginx/ssl/default.crt;
    ssl_certificate_key /etc/nginx/ssl/default.key;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    return 444;
}
```

**Директивы:**
- `listen 443 ssl default_server` - Прослушивать порт 443 с SSL как default server
- `ssl_certificate` - Путь к SSL сертификату
- `ssl_certificate_key` - Путь к приватному ключу SSL
- `ssl_protocols` - Разрешенные версии TLS
- `ssl_prefer_server_ciphers on` - Предпочитать шифры сервера

## Генерация SSL сертификатов

Для HTTPS default server необходим SSL сертификат. Можно использовать самоподписанный сертификат:

```bash
# Создать каталог для сертификатов
mkdir -p /etc/nginx/ssl

# Сгенерировать самоподписанный сертификат
openssl req -x509 -nodes -newkey rsa:2048 \
  -keyout /etc/nginx/ssl/default.key \
  -out /etc/nginx/ssl/default.crt \
  -days 365 \
  -subj "/CN=default.invalid"
```

**Параметры:**
- `-x509` - Создать самоподписанный сертификат
- `-nodes` - Не шифровать приватный ключ паролем
- `-newkey rsa:2048` - Создать новый RSA ключ размером 2048 бит
- `-keyout` - Путь к выходному файлу приватного ключа
- `-out` - Путь к выходному файлу сертификата
- `-days 365` - Срок действия сертификата (365 дней)
- `-subj` - Информация о субъекте сертификата

**Установка прав доступа:**
```bash
chmod 600 /etc/nginx/ssl/default.key
chmod 644 /etc/nginx/ssl/default.crt
```

## Размещение конфигурации

### Вариант 1: В основном конфигурационном файле

Добавить блоки в `/etc/nginx/nginx.conf` или основной конфигурационный файл.

### Вариант 2: Отдельный файл

Создать отдельный файл (например, `/etc/nginx/conf.d/default-server.conf`) и подключить его в основной конфигурации:

```nginx
# В /etc/nginx/nginx.conf или /etc/nginx/sites-enabled/default
include /etc/nginx/conf.d/default-server.conf;
```

**Преимущества:**
- Легче управлять конфигурацией
- Можно отключить без изменения основного файла
- Удобно для версионирования

## Проверка конфигурации

После добавления конфигурации:

```bash
# Проверить синтаксис конфигурации
nginx -t

# Перезагрузить конфигурацию
systemctl reload nginx
# или
nginx -s reload
```

## Тестирование

### Проверка HTTP

```bash
# Запрос по IP должен быть отклонен
curl -v http://<server-ip>/

# Запрос по несуществующему домену должен быть отклонен
curl -v -H "Host: invalid.example.com" http://<server-ip>/
```

### Проверка HTTPS

```bash
# Запрос по IP должен быть отклонен
curl -v -k https://<server-ip>/

# Запрос по несуществующему домену должен быть отклонен
curl -v -k -H "Host: invalid.example.com" https://<server-ip>/
```

**Ожидаемое поведение:**
- Соединение закрывается без ответа (код 444)
- Нет HTTP заголовков в ответе
- Соединение разрывается сразу

## Рекомендации

1. **Размещение блоков:** Размещайте default server блоки **перед** другими блоками server в конфигурации
2. **SSL сертификаты:** Используйте самоподписанные сертификаты только для default server; для реальных доменов используйте валидные сертификаты
3. **Логирование:** Рассмотрите возможность добавления логирования для мониторинга отклоненных запросов:
   ```nginx
   access_log /var/log/nginx/default-server.log;
   ```
4. **Безопасность:** Регулярно обновляйте SSL протоколы и шифры в соответствии с рекомендациями безопасности
5. **Тестирование:** Всегда тестируйте конфигурацию после изменений

## Дополнительная информация

- Код 444 - специальный код Nginx, который закрывает соединение без отправки заголовков ответа
- `server_name _` - специальное значение, которое соответствует любому имени, не совпадающему с другими блоками
- `default_server` - флаг, указывающий, что этот блок должен использоваться для запросов, не соответствующих другим блокам

## Связанные заметки

- [[../Linux/System Administration]] - Системное администрирование
- [[../Security/Security Tools]] - Инструменты безопасности

